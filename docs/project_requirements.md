# 지하철 혼잡도 대시보드 프로젝트 요구사항 정의서

## 1. 프로젝트 개요

### 1.1 목적
서울교통공사 지하철 혼잡도 데이터를 시각화하여 운영자가 역별·요일별·시간대별 혼잡도를 효과적으로 분석할 수 있는 대시보드 구축

### 1.2 데이터 소스
- **파일명**: `서울교통공사_지하철혼잡도정보_20250930.csv`
- **형태**: Wide 포맷 (1,671행 × 39개 시간 컬럼)
- **범위**: 1~8호선, 283개 역, 평일/토요일/일요일

### 1.3 기술 스택
- **언어**: Python 3.8+
- **프레임워크**: Streamlit
- **라이브러리**: pandas, numpy, plotly
- **배포**: 로컬 실행 (향후 날짜별 파일 업로드 가능성 고려)

---

## 2. 사용자 및 사용 시나리오

### 2.1 주 사용자
- **운영자** (서울교통공사 운영 관리 담당)

### 2.2 핵심 사용 시나리오
운영자가 대시보드에 접속하여 **필터를 통해 역별·요일별 혼잡도를 확인**하고, 출퇴근 시간대의 혼잡 패턴을 분석하여 운영 의사결정에 활용

---

## 3. 데이터 정의

### 3.1 혼잡도 값의 의미
- **단위**: 상대적 혼잡도 지수
- **해석**: 
  - `0` = 실제로 사람이 없음 (유효값)
  - 값이 클수록 혼잡
  - 최소: 0.0, 최대: 164.3, 평균: 28.4

### 3.2 색상 기준
- **스케일**: 초록(덜 혼잡) → 빨강(혼잡) 그라데이션
- **방식**: 호선별 분위수 기반 (호선 내 상대 비교)
  - 초록: 하위 0~50%
  - 연두/노랑: 50~75%
  - 주황: 75~90%
  - 빨강: 상위 90~100%

### 3.3 핵심 시간대 정의
- **출근 시간대**: 07:30 ~ 09:30 (끝시간 포함)
- **퇴근 시간대**: 17:30 ~ 19:30 (끝시간 포함)
- **집계 방식**: 해당 시간대 구간의 **평균값**

### 3.4 요일 구분
- 평일
- 토요일
- 일요일

### 3.5 방향 구분
- 1호선: 상선/하선
- 2호선: 내선/외선
- 기타 호선: 상선/하선
- **처리**: 전부 지원 (호선별로 존재하는 방향만 노출)

---

## 4. 데이터 스키마

### 4.1 정제 후 스키마 (Tidy/Long 포맷)

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `day_type` | string | 요일 구분 | 평일, 토요일, 일요일 |
| `line` | string | 호선 | 1호선, 2호선, ... |
| `station_code` | string | 역번호 | 150, 151, ... |
| `station_name` | string | 역명 | 서울역, 시청, ... |
| `direction` | string | 방향 | 상선, 하선, 내선, 외선 |
| `time_label` | string | 시간대 (HH:MM) | 07:30, 08:00, ... |
| `time_order` | int | 시간 정렬용 (0~38) | 0, 1, 2, ... |
| `crowding` | float | 혼잡도 | 0.0 ~ 164.3 |

### 4.2 데이터 품질 현황
- ✅ 키 중복: 0건
- ✅ 음수 혼잡도: 0건
- ✅ 결측(NaN): 0건 (0.00%)
- ℹ️ 전 시간대 0인 역×방향: 42건 (운영 확인 필요)

---

## 5. 구현 단계 (Phased Approach)

### Phase 1: 데이터 준비 및 정제 ✅ **완료**
**목표**: 원본 CSV를 대시보드에서 사용 가능한 롱 포맷으로 변환

**작업 내용**:
- Wide → Long 포맷 변환
- 타입 파싱 (0은 유효값 유지)
- 시간 정렬 보장 (`time_order`)
- 데이터 품질 검증 리포트 생성

**산출물**:
- `data/subway_crowding_tidy.csv` (65,169행)
- `data/subway_crowding_tidy.parquet`
- `data/quality_report.json`

**완료 조건**:
- [x] 키 중복 0건
- [x] 음수 혼잡도 0건
- [x] 스키마 정상화

---

### Phase 2: 역 상세 라인차트 (MVP-1) 🔜 **예정**
**목표**: 특정 역의 하루 혼잡도 패턴을 시간대별로 확인

**화면 구성**:
- **사이드바**: 필터 전체
  - 요일구분 (selectbox)
  - 호선 (selectbox)
  - 출발역 (selectbox, 선택한 호선의 역만 노출)
  - 상하구분 (selectbox, 선택한 호선의 방향만 노출)
  - 시간대 범위 (slider, 선택적)
- **본문**: 
  - 선택된 역의 하루 혼잡도 라인차트
  - x축: 시간대 (05:30 ~ 00:30)
  - y축: 혼잡도
  - 출근/퇴근 시간대 영역 강조 (배경색)

**주요 기능**:
- 필터 변경 시 실시간 차트 업데이트
- 0값 처리 (실제 0으로 표시)
- 호버 시 상세 정보 표시

---

### Phase 3: 역×시간대 히트맵 (MVP-2) 🔜 **예정**
**목표**: 여러 역의 혼잡 패턴을 한눈에 비교

**화면 구성**:
- Phase 2 필터 유지
- **히트맵**:
  - x축: 시간대 (30분 단위)
  - y축: 역 (혼잡도 평균 내림차순 정렬, 기본값)
  - 색상: 초록 → 빨강 (호선별 분위수 스케일)
- **정렬 옵션** (드롭다운):
  - 평균 혼잡도 내림차순 (기본)
  - 가나다순
  - 역번호순

**주요 기능**:
- 선택한 조건(요일/호선/방향)에서 상위 혼잡 역이 상단에 노출
- 출근/퇴근 시간대 컬럼 강조
- 히트맵 클릭 시 해당 역 상세로 이동 (선택적)

---

### Phase 4: Top N 랭킹 (MVP-3) 🔜 **예정**
**목표**: 가장 혼잡한 역을 빠르게 파악

**화면 구성**:
- **토글**: 출근 / 퇴근 전환
- **필터**: 요일구분, 호선 (복수 선택 가능하도록 개선 검토)
- **랭킹 테이블**:
  - 순위, 역명, 호선, 방향, 평균 혼잡도, 피크 시간대
  - 기본 Top 10 (조정 가능)
- **막대 차트** (선택적)

**집계 기준**:
- 선택한 시간대(출근/퇴근) 구간의 **평균 혼잡도**
- 역×방향 단위로 집계

---

### Phase 5: 확장 기능 🔜 **예정**
**목표**: 운영 편의성 향상

**기능 목록**:
- **KPI 요약 카드**: 전체 평균, 최고 혼잡역, 피크 시간대
- **결과 다운로드**: CSV/Excel 내보내기
- **즐겨찾기 역**: 자주 보는 역 저장
- **날짜별 파일 업로드**: 
  - 파일 선택 위젯
  - 자동 형식 검증
  - 날짜별 비교 (선택적)

---

## 6. 필터 상세 명세

### 6.1 필수 필터 (Phase 2~4 공통)

| 필터명 | 타입 | 동작 | 비고 |
|--------|------|------|------|
| 요일구분 | selectbox | 평일/토요일/일요일 선택 | 기본값: 평일 |
| 호선 | selectbox | 1~8호선 선택 | 기본값: 1호선 |
| 출발역 | selectbox | 선택한 호선의 역만 노출 | 가나다순 정렬 |
| 상하구분 | selectbox | 선택한 호선의 방향만 (상/하/내/외) | 동적 필터링 |
| 시간대 범위 | slider (선택적) | 05:30 ~ 00:30 범위 조정 | Phase 2에서 구현 검토 |

### 6.2 필터 연동 규칙
1. 호선 변경 → 출발역/상하구분 목록 자동 갱신
2. 모든 필터 변경 → 차트/테이블 즉시 반영
3. 유효하지 않은 조합 선택 시 → 경고 메시지 + 기본값 복원

---

## 7. UI/UX 가이드

### 7.1 레이아웃
```
┌─────────────────────────────────────────┐
│  [타이틀] 지하철 혼잡도 대시보드          │
├─────────┬───────────────────────────────┤
│         │                               │
│ [사이드바]│  [본문 영역]                  │
│         │                               │
│ 필터:    │  - KPI 카드 (Phase 5)        │
│  요일    │  - Top N 랭킹 (Phase 4)       │
│  호선    │  - 히트맵 (Phase 3)           │
│  역      │  - 라인차트 (Phase 2)         │
│  방향    │                               │
│         │                               │
└─────────┴───────────────────────────────┘
```

### 7.2 색상 팔레트
- **혼잡도 스케일**: `plotly.colors.sequential.RdYlGn_r` (빨강-노랑-초록 역순)
- **출퇴근 시간대 강조**: 반투명 회색 배경
- **선택 영역**: Streamlit 기본 강조색 활용

### 7.3 반응형
- PC 우선 (운영자 환경)
- 최소 해상도: 1280×720
- 차트 너비 자동 조정 (`use_container_width=True`)

---

## 8. 성능 고려사항

### 8.1 데이터 로딩
```python
@st.cache_data
def load_data():
    return pd.read_parquet('data/subway_crowding_tidy.parquet')
```

### 8.2 필터링 최적화
- Parquet 포맷 사용 (CSV 대비 ~5배 빠름)
- 필터 후 데이터만 차트에 전달
- 집계 결과 캐싱 (출근/퇴근 평균 등)

---

## 9. 프로젝트 파일 구조

```
multicampus-moon/
├── README.md
├── requirements.txt
├── data_preprocessing.py          # Phase 1 스크립트
├── app.py                         # Streamlit 앱 (Phase 2~)
├── 서울교통공사_지하철혼잡도정보_20250930.csv
├── data/                          # 정제된 데이터
│   ├── subway_crowding_tidy.csv
│   ├── subway_crowding_tidy.parquet
│   └── quality_report.json
├── docs/                          # 문서
│   └── project_requirements.md
└── utils/                         # 유틸리티 (Phase 3~)
    ├── filters.py                 # 필터 로직
    ├── charts.py                  # 차트 생성 함수
    └── aggregations.py            # 집계 함수
```

---

## 10. Phase 1 완료 체크리스트

- [x] 원본 CSV 읽기 (인코딩 자동 감지)
- [x] Wide → Long 포맷 변환
- [x] 시간 컬럼 정규화 (HH:MM, time_order)
- [x] 혼잡도 타입 파싱 (0 유지)
- [x] 키 중복 검증 (0건)
- [x] 음수 검증 (0건)
- [x] 품질 리포트 생성 (JSON)
- [x] CSV/Parquet 저장

**Phase 1 상태**: ✅ **완료** (2025-12-16)

---

## 11. 다음 단계 실행 가이드

### Phase 2 시작 명령
```bash
# Streamlit 앱 생성 및 실행
streamlit run app.py
```

### Phase 2 개발 순서
1. 데이터 로딩 함수 (`@st.cache_data`)
2. 사이드바 필터 구현
3. 필터 연동 로직 (호선→역, 호선→방향)
4. 라인차트 생성 (`plotly.express.line`)
5. 출퇴근 시간대 영역 강조 (`fig.add_vrect`)

---

## 12. 참고 자료

- **Streamlit 공식 문서**: https://docs.streamlit.io
- **Plotly 차트 갤러리**: https://plotly.com/python/
- **Pandas 최적화**: https://pandas.pydata.org/docs/user_guide/enhancingperf.html

---

**문서 버전**: 1.0  
**최종 수정**: 2025-12-16  
**작성자**: 프로젝트 기획팀
