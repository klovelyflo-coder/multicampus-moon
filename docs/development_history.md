# 📜 개발 히스토리

지하철 혼잡도 대시보드 프로젝트의 단계별 개발 과정을 기록한 문서입니다.

---

## Phase 1: 데이터 정제 (Data Preparation)

### 목표
원본 CSV 데이터를 분석 가능한 형태로 변환

### 주요 작업
- ✅ CSV 파일 로드 및 구조 분석
- ✅ Wide format → Tidy format 변환
- ✅ 데이터 품질 검증 (결측치, 이상치 확인)
- ✅ Parquet 포맷으로 저장하여 성능 최적화
- ✅ 품질 리포트 생성 (JSON)

### 결과물
- `scripts/data_preparation.py`: 데이터 정제 스크립트
- `data/subway_crowding_tidy.parquet`: 정제된 데이터
- `data/quality_report.json`: 데이터 품질 리포트

### Git 태그
`phase1-complete`

---

## Phase 2: 역 상세 라인차트 (Station Detail Dashboard)

### 목표
특정 역의 시간대별 혼잡도를 시각화하는 기본 대시보드 구현

### 주요 작업
- ✅ Streamlit 기반 대시보드 구조 설계
- ✅ 사이드바 필터 구현 (요일, 호선, 역, 방향)
- ✅ Plotly를 사용한 인터랙티브 라인차트
- ✅ 출퇴근 시간대 시각적 강조 (색상 영역 추가)
- ✅ 호선별 방향 설명 추가 (예: 2호선 내선/외선)

### 기술 스택
- Streamlit: 대시보드 프레임워크
- Plotly Express: 시각화 라이브러리
- Pandas: 데이터 처리

### 주요 기능
```python
- 동적 필터링 (요일, 호선, 역, 방향)
- 시간대별 혼잡도 추이 라인차트
- 출근/퇴근 시간대 강조 표시
- 호버 인터랙션
```

### Git 태그
`phase2-complete`

---

## Phase 3: 히트맵 시각화 (Heatmap Visualization)

### 목표
호선 전체 역의 혼잡도를 한눈에 비교할 수 있는 히트맵 추가

### 주요 작업
- ✅ 역×시간대 매트릭스 히트맵 구현
- ✅ 역 정렬 옵션 (평균 혼잡도, 가나다순, 역번호순)
- ✅ 색상 스케일 최적화 (RdYlGn_r)
- ✅ 히트맵-라인차트 연동 (클릭 시 해당 역 상세보기)
- ✅ 동적 높이 조정 (역 개수에 비례)

### 인터랙티브 기능
- 히트맵에서 역 클릭 → 라인차트 자동 업데이트
- 세션 상태 관리로 선택 역 추적

### Git 태그
`phase3-complete`

---

## Phase 4: Top N 랭킹 (Top N Ranking)

### 목표
출퇴근 시간대 가장 혼잡한 역 순위 제공

### 주요 작업
- ✅ 출근/퇴근 시간대 정의 (07:30-09:30, 17:30-19:30)
- ✅ 랭킹 계산 알고리즘 구현
- ✅ Top N 슬라이더 (5~20개 역 선택 가능)
- ✅ 랭킹 테이블 (순위, 역명, 호선, 방향, 평균 혼잡도, 피크 시간)
- ✅ 막대 차트 시각화
- ✅ 랭킹에서 역 선택 → 라인차트 연동

### 주요 함수
```python
calculate_rush_hour_ranking()
- 시간대별 데이터 필터링
- 역별 평균 혼잡도 계산
- 피크 시간 추출
- Top N 정렬
```

### Git 태그
`phase4-complete`

---

## Phase 5: KPI 요약 카드 (KPI Summary Cards)

### 목표
핵심 지표를 한눈에 파악할 수 있는 요약 카드 추가

### 주요 작업
- ✅ KPI 계산 함수 구현
- ✅ 4개 주요 지표 카드
  - 총 역 수
  - 전체 평균 혼잡도
  - 최고 혼잡역
  - 피크 시간대
- ✅ 출퇴근 시간대 평균 카드 (2개)
  - 출근 시간대 평균 (07:30-09:30)
  - 퇴근 시간대 평균 (17:30-19:30)

### 주요 함수
```python
calculate_kpi()
- 역 수 집계
- 평균/최대 혼잡도 계산
- 피크 시간대 추출
- 출퇴근 평균 계산
```

### Git 태그
`phase5-kpi-complete`

---

## UI 개선: 탭 구조 및 독립 필터 (UI Refactoring)

### 배경
- 문제점: 세로 스크롤이 너무 길어서 사용성 저하
- 필터 문제: 탭 간 변수 공유로 `UnboundLocalError` 발생

### 목표
사용자 경험 개선을 위한 UI 재구조화

### 주요 작업
- ✅ 사이드바 라디오 버튼으로 3개 메뉴 구현
  - 📈 역 상세 분석
  - 🏆 전체 혼잡도 랭킹
  - 📊 노선별 분석
- ✅ 메뉴별 독립적인 필터 시스템
  - 탭1: 사이드바 필터 (요일, 호선, 역, 방향)
  - 탭2: 독립 필터 (요일, 시간대, Top N)
  - 탭3: 독립 필터 (호선, 요일, 방향)
- ✅ 차트 높이 최적화 (500px → 350px)
- ✅ 테이블 높이 동적 조정
- ✅ 히트맵 높이 자동 계산 (역 수 × 18px)

### 버그 수정
- `UnboundLocalError` 수정: 탭2에서 `selected_day` 참조 제거
- 들여쓰기 오류 수정: 탭 블록 내부 코드 정렬

### 노선별 분석 탭 개선
- 히트맵 중심 분석
- 역 선택 시 하단에 라인차트 표시
- 랭킹 기능 제거로 집중도 향상

### Git 커밋
`bbefc06` - refactor: UI 구조 개선 - 탭 메뉴와 독립적 필터 구현

---

## UI 개선 2차: 사용자 경험 향상 (UX Improvements)

### 배경
- 사용자 피드백 반영
- 평일과 주말의 혼잡도 패턴 차이 고려
- 랭킹에서 역별 상세 정보 접근성 개선

### 목표
더 직관적이고 사용자 친화적인 인터페이스 구현

### 주요 작업

#### 1. 평일/주말 구분 로직
**문제점**: 주말에는 출퇴근 시간대 개념이 부적절함

**해결책**:
- 평일 선택 시: 출근/퇴근 시간대 라디오 버튼 표시
- 주말 선택 시: 출퇴근 선택 숨김, 전체 시간대(05:30~00:30) 랭킹 자동 표시

**구현**:
```python
if ranking_day == "평일":
    rush_hour_option = st.radio(...)  # 출근/퇴근 선택
    rush_type = "morning" or "evening"
else:
    rush_type = "all_day"  # 전체 시간대
```

**함수 수정**: `calculate_rush_hour_ranking`에 "all_day" 타입 추가

#### 2. 히트맵 높이 자동 조정
**문제점**: 역이 많을 때 일부만 렌더링되는 문제

**해결책**:
- 역당 픽셀 증가: 18px → 40px
- 최소 높이 증가: 300px → 400px

**결과**: 1호선 10개 역 모두 정상 표시

#### 3. 역별 상세 차트 제공 (Expander)
**문제점**: 랭킹 테이블에서 역의 시간대별 추이를 바로 확인할 수 없음

**해결책**: 각 역마다 접었다 펼칠 수 있는 Expander 제공

**기능**:
- 랭킹 순위별로 Expander 생성
- Expander 제목: "N위. 역명 (호선 방향) - 평균 혼잡도"
- Expander 내용: 해당 역의 시간대별 라인차트
- 평일만 출퇴근 시간대 강조 표시

**장점**:
- 관심 있는 역만 선택적으로 확인 가능
- 여러 역 동시 비교 가능
- 팝업 없이 깔끔한 UI 유지

### 개선 효과
- **직관성**: 평일과 주말을 구분하여 적절한 시간대 분석
- **정확성**: 히트맵 렌더링 문제 해결로 모든 역 표시
- **편의성**: Expander로 역별 상세 정보 즉시 접근

---

## 데이터 제약사항

### 1호선 데이터 한계
- 포함된 역: 10개 (서울역~외대앞)
- 이유: 서울교통공사 관할 구간만 포함
- 누락 구간: 코레일 운영 구간 (소요산, 청량리 이북, 인천 방면 등)

---

## 기술 스택

### 프론트엔드
- **Streamlit**: 대시보드 프레임워크
- **Plotly Express**: 인터랙티브 차트 라이브러리

### 데이터 처리
- **Pandas**: 데이터 처리 및 분석
- **Parquet**: 효율적인 데이터 저장 포맷

### 버전 관리
- **Git**: 소스 코드 관리
- **GitHub**: 원격 저장소

---

## 성능 최적화

1. **데이터 로딩**
   - Parquet 포맷 사용으로 CSV 대비 빠른 로딩
   - 캐싱으로 중복 로딩 방지

2. **차트 렌더링**
   - 적절한 차트 높이 설정
   - 필요한 데이터만 필터링하여 표시

3. **메모리 관리**
   - 세션 상태 최소화
   - 불필요한 데이터 복사 방지

---

## 향후 개선 방향

### 기능 추가
- [ ] 날짜별 혼잡도 비교 (주별, 월별 추이)
- [ ] 노선 간 혼잡도 비교 분석
- [ ] 혼잡도 예측 기능
- [ ] 최적 경로 추천 (덜 혼잡한 경로)
- [ ] 알림 기능 (특정 역의 혼잡도 임계값 초과 시)

### 데이터 확장
- [ ] 코레일 구간 데이터 통합
- [ ] 9호선, 신분당선 등 추가 노선
- [ ] 실시간 혼잡도 API 연동

### UI/UX 개선
- [ ] 다크 모드 지원
- [ ] 모바일 반응형 디자인
- [ ] 북마크 기능 (자주 보는 역 저장)
- [ ] PDF 리포트 다운로드

### 분석 기능
- [ ] 통계 분석 (표준편차, 백분위수 등)
- [ ] 이상 패턴 탐지
- [ ] 혼잡도 패턴 클러스터링

---

## 프로젝트 타임라인

```
2024-12
├── Phase 1: 데이터 정제 완료
├── Phase 2: 라인차트 대시보드 완료
├── Phase 3: 히트맵 추가 완료
├── Phase 4: Top N 랭킹 완료
├── Phase 5: KPI 카드 추가 완료
├── UI 개선 1차: 탭 구조 리팩토링 완료
└── UI 개선 2차: 사용자 경험 향상 완료
    ├── 평일/주말 구분 로직
    ├── 히트맵 높이 자동 조정
    └── 역별 Expander 차트
```

---

## 참고 자료

- 원본 데이터: 서울교통공사 지하철혼잡도정보 (2024년 9월 30일 기준)
- Streamlit 문서: https://docs.streamlit.io
- Plotly 문서: https://plotly.com/python/
- Pandas 문서: https://pandas.pydata.org

---

**마지막 업데이트**: 2024-12-16  
**버전**: v1.1 (UI 개선 2차 완료)
